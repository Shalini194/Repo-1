name: Merge PR from Fork

on:
  pull_request_review:
    types: [submitted]

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the code
      uses: actions/checkout@v3

    - name: Install yq
      run: |
        sudo apt-get update && sudo apt-get install -y yq

    - name: Check if the PR is approved
      id: check_approval
      run: |
        PR_NUMBER=$(yq e .pull_request.number < $GITHUB_EVENT_PATH)
        APPROVED=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" | \
          yq e 'map(select(.state == "APPROVED")) | length > 0')

        if [[ "$APPROVED" != "true" ]]; then
          echo "PR is not approved, exiting"
          exit 1
        fi

    - name: Merge PR
      if: steps.check_approval.outcome == 'success'
      run: |
        PR_NUMBER=$(yq e .pull_request.number < $GITHUB_EVENT_PATH)
        curl -X PUT -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -d '{"merge_method":"merge"}' \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge"
